# ホーム画面AIチャット統合 - 実装計画

現在、ホーム画面の入力フォームからメッセージを送信すると `/chat` ページに遷移する仕様を、**ホーム画面上で直接チャットのやり取りができる**よう改善します。

---

## 現状の動作フロー

```mermaid
flowchart LR
    A[ホーム画面] -->|メッセージ入力| B[quick-chat-input.tsx]
    B -->|セッション作成| C[LocalStorageに保存]
    C -->|ページ遷移| D[/chat?session=XX&pending=true]
    D -->|pendingメッセージ取得| E[chat-client.tsx]
    E -->|API呼び出し| F[/api/chat]
```

---

## 提案する新しい動作フロー

```mermaid
flowchart LR
    A[ホーム画面] -->|メッセージ入力| B[inline-chat.tsx]
    B -->|useChat hook| C[/api/chat]
    C -->|ストリーミング応答| B
    B -->|メッセージ表示| A
```

**ポイント**: ページ遷移なしで、ホーム画面内でチャットのやり取りが完結する。

---

## 提案する変更

### ダッシュボードコンポーネント

#### [NEW] [inline-chat.tsx](file:///d:/Dev/nofap-ai/components/dashboard/inline-chat.tsx)

ホーム画面に埋め込むインラインチャットコンポーネント。主な機能:
- `@ai-sdk/react`の`useChat`フックを使用してAI対話を処理
- セッション管理（新規作成・既存セッション継続）
- メッセージ表示エリア（スクロール可能、最大高さ制限）
- 入力フォーム・送信ボタン
- ローディング状態表示
- クイックアクションボタン（「誘惑に負けそう」「メリットを教えて」など）

#### [MODIFY] [page.tsx](file:///d:/Dev/nofap-ai/app/page.tsx)

- `QuickChatInput`を`InlineChat`に置き換え
- 初期セッションIDとメッセージをサーバーサイドで取得してpropsで渡す

#### [DELETE or DEPRECATE] [quick-chat-input.tsx](file:///d:/Dev/nofap-ai/components/dashboard/quick-chat-input.tsx)

- 不要になるため削除または非推奨化

---

## UI デザイン案

```
┌─────────────────────────────────────────────────────┐
│  AIアシスタントに相談                               │
├─────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────┐ │
│ │ [メッセージ表示エリア - 最大300px高さ]          │ │
│ │                                                 │ │
│ │  👤 こんにちは                                  │ │
│ │  🤖 こんにちは！何かお手伝いできることは...     │ │
│ │                                                 │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ [クイックアクション: 誘惑に負けそう][メリット教えて]│
│                                                     │
│ ┌─────────────────────────────────────┐ [送信]     │
│ │ メッセージを入力...                 │            │
│ └─────────────────────────────────────┘            │
│                                                     │
│ [過去のチャット履歴を見る →]                        │
└─────────────────────────────────────────────────────┘
```

---

## 検証計画

### 手動テスト

1. **基本的なチャット機能**
   - ホーム画面でメッセージを入力して送信
   - AIからの応答がストリーミングで表示されることを確認
   - メッセージがデータベースに保存されることを確認

2. **クイックアクション**
   - 「誘惑に負けそう」ボタンをクリック
   - 自動メッセージが送信され、応答が返ることを確認

3. **レスポンシブデザイン**
   - モバイル画面でのUI表示を確認
   - タブレット・デスクトップでの表示を確認

4. **セッション管理**
   - 既存セッションがある場合、メッセージ履歴が表示されることを確認
   - 新規ユーザーの場合、新しいセッションが作成されることを確認

5. **エラーハンドリング**
   - ネットワークエラー時の動作確認
   - 空メッセージ送信防止の確認

> [!NOTE]
> 現在、自動テストは存在しないため、手動テストで検証します。

---

## 追加検討事項

> [!IMPORTANT]
> **過去のチャット履歴へのアクセス**
> - `/chat`ページは履歴参照用に残すか、完全に削除するか決定が必要です
> - 「過去のチャット履歴を見る」リンクで`/chat`に遷移するオプションもあります

**質問**:
1. 過去のチャット履歴閲覧は `/chat` ページを残して対応しますか？それともホーム画面に履歴表示機能も追加しますか？
2. チャットエリアの最大高さはどのくらいが適切ですか？（提案: 300px〜400px）
